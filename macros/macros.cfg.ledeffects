# "macros.cfg"

[delayed_gcode _set_toolhead_led_delayed]
initial_duration: 0.0
gcode:
    ; M118 "DEBUG_LED_FIRED: _set_toolhead_led_delayed has fired!" ; Removed debug message
    
    {% set red = params.RED|float %}
    {% set green = params.GREEN|float %}
    {% set blue = params.BLUE|float %}

    ; M118 "DEBUG_LED_FIRED: Received R={red}, G={green}, B={blue} from parameters. Attempting SET_LED." ; Removed debug message

    ; Construct and execute the SET_LED command directly within this macro
    SET_LED LED=toolhead_led RED={red} GREEN={green} BLUE={blue} TRANSMIT=1
    ; M118 "DEBUG_LED_FIRED: SET_LED command executed." ; Removed debug message

[gcode_macro SET_TOOLHEAD_LED_STATUS]
description: Updates a G-code variable for toolhead LED color and triggers delayed update.
variable_toolhead_led_color_r = 0.0
variable_toolhead_led_color_g = 0.0
variable_toolhead_led_color_b = 0.0
gcode:
    {% set status_color = params.COLOR|default("OFF") %}
    {% set red = 0.0 %}
    {% set green = 0.0 %}
    {% set blue = 0.0 %}

    {% if status_color == "ORANGE" %}
        {% set red = 1.0 %}
        {% set green = 0.5 %}
        {% set blue = 0.0 %}
    {% elif status_color == "BLUE" %}
        {% set red = 0.0 %}
        {% set green = 0.0 %}
        {% set blue = 1.0 %}
    {% elif status_color == "YELLOW" %}
        {% set red = 1.0 %}
        {% set green = 1.0 %}
        {% set blue = 0.0 %}
    {% elif status_color == "GREEN" %}
        {% set red = 0.0 %}
        {% set green = 1.0 %}
        {% set blue = 0.0 %}
    {% elif status_color == "RED" %}
        {% set red = 1.0 %}
        {% set green = 0.0 %}
        {% set blue = 0.0 %}
    {% endif %}

    ; Update the G-code variables that the delayed macro will read
    SET_GCODE_VARIABLE MACRO=SET_TOOLHEAD_LED_STATUS VARIABLE=toolhead_led_color_r VALUE={red}
    SET_GCODE_VARIABLE MACRO=SET_TOOLHEAD_LED_STATUS VARIABLE=toolhead_led_color_g VALUE={green}
    SET_GCODE_VARIABLE MACRO=SET_TOOLHEAD_LED_STATUS VARIABLE=toolhead_led_color_b VALUE={blue}
    
    ; M118 "DEBUG_LED_CALL: Updated G-code variables. Scheduling _set_toolhead_led_delayed." ; Removed debug message
    UPDATE_DELAYED_GCODE ID=_set_toolhead_led_delayed DURATION=0.05 ; No parameters here, relies on variables

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
Â  ##### get user parameters or use default #####Â 
Â  {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
Â  {% set idle_timeout = client.idle_timeout|default(0) %}
Â  {% set temp = printer[printer.toolhead.extruder].target if printer.toolhead.extruder != '' else 0 %}
Â  {% set restore = False if printer.toolhead.extruder == ''
Â  Â  Â  Â  Â  Â  Â else TrueÂ  if params.RESTORE|default(1)|int == 1 else False %}
Â  ##### end of definitions #####
Â  SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=last_extruder_temp VALUE="{{'restore': restore, 'temp': temp}}"
Â  # set a new idle_timeout value
Â  {% if idle_timeout > 0 %}
Â  Â  SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=restore_idle_timeout VALUE={printer.configfile.settings.idle_timeout.timeout}
Â  Â  SET_IDLE_TIMEOUT TIMEOUT={idle_timeout}
Â  {% endif %}
Â  PAUSE_BASE
Â  SET_TOOLHEAD_LED_STATUS COLOR="YELLOW" ; Yellow for paused
Â  {client.user_pause_macro|default("")}
Â  _TOOLHEAD_PARK_PAUSE_CANCEL {rawparams}

[gcode_macro PARK]
gcode:
Â  Â  {% set th = printer.toolhead %}
Â  Â  G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30Â Â 

[gcode_macro G32]
gcode:
Â  Â  BED_MESH_CLEAR
Â  Â  G28
Â  Â QUAD_GANTRY_LEVEL
Â  Â G28
Â  Â  G0 X87.5 Y90 Z30 F3600
Â  Â Â 

[gcode_macro PRIME]
gcode:
Â  {% set x_mid = printer.toolhead.axis_maximum.x|float / 2 %}
Â  G0 X{x_mid - 50} Y4 F10000Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # Go to starting point
Â  G0 Z0.4Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # Raise Z to 0.4
Â  G91Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # Incremental positioningÂ 
Â  G1 X100 E20 F1000Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # Primeline
Â  G90

[gcode_macro TEST_LED_COLOR]
description: Temporarily test setting toolhead LED to RED directly.
gcode:
    ; M118 "DEBUG_TEST: TEST_LED_COLOR macro fired directly. Attempting to set RED." ; Removed debug message
    SET_LED LED=toolhead_led RED=1.0 GREEN=0.0 BLUE=0.0 TRANSMIT=1 ; Force LED to RED
    ; M118 "DEBUG_TEST: Forced RED command sent directly." ; Removed debug message


[gcode_macro testy]
gcode:
Â  #G4 P{printer["gcode_macro _PRINTER_SETTINGS"].prepurge_dwell * 1000}
Â  #RESPOND TYPE=echo MSG="dwelling"
Â  #RESPOND TYPE=echo MSG='{"Move isÂ  %d" % (tilt_height)}'Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  #RESPOND TYPE=echo MSG='{"park macro isÂ  %s" % (macro_park)}'

Â  RESPOND PREFIX=ðŸ’¨ MSG=" {planeCfg} {planeCMD} "

[delayed_gcode delayed_fan_shutoff]
initial_duration: 0.0 ; Don't run immediately on Klipper start
gcode:
Â  Â  M118 "Delayed fan shutoff active (10 minutes reached)."
Â  Â  {% if printer.fan.mcu is defined %}
Â  Â  Â  Â  SET_FAN_SPEED FAN=mcu SPEED=0 ; Turn off electronics cooling fan if defined
Â  Â  {% endif %}

Â  Â  {% if printer.fan.Skirt_Fans is defined %}
Â  Â  Â  Â  SET_FAN_SPEED FAN=Skirt_Fans SPEED=0 ; Turn off skirt/auxiliary fan if defined
Â  Â  {% endif %}
Â Â 
[delayed_gcode chill_absprint]
gcode:
Â  {% if printer.heater_bed.temperature > 80 %}
Â  Â  SET_DISPLAY_TEXT MSG="reduce temp to ({printer.heater_bed.target - 5 }CÂ°)."
Â  Â  M140 S{ printer.heater_bed.target - 5 }
Â  Â  UPDATE_DELAYED_GCODE ID=chill_absprint DURATION=300
Â  {% else %}
Â  Â  SET_DISPLAY_TEXT MSG="No Gradual bed cooling necessary ({printer.heater_bed.temperature}CÂ°)."
Â  Â  M140 S0 ; turn off bed
Â  Â  #M81 ; disable Power
Â  Â  SET_DISPLAY_TEXT MSG="Print Complete!"
Â  {% endif %}

Â  M106 S85
Â  TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=150
Â  SET_FAN_SPEED FAN=mcu SPEED=1.0Â 
Â Â 
Â  {% set posCenter = printer.configfile.config.bed_mesh.zero_reference_position %}
Â  {% set moveAccelÂ  = printer.configfile.config.printer.max_accel | int * 0.80 %}
Â  G91
Â  G0 Z20
Â  G90
Â  G1 X{posCenter.split(",")[0]|float} Y{posCenter.split(",")[1]|float} F{moveAccel}
Â Â 
Â  M84

Â  G4 P300000
Â  M140 S105
Â  G4 P300000
Â  M140 S100
Â  G4 P300000
Â  M140 S95
Â  G4 P300000
Â  M140 S90
Â  G4 P300000

Â  M106 S0
Â  M140 S0
Â  SET_FAN_SPEED FAN=mcu SPEED=0

[gcode_macro SET_VELOCITY_LIMIT]
rename_existing: _SET_VELOCITY_LIMIT
description: Alter the velocity limits unless printer is in nightmode
variable_nightmode: 0Â 
gcode:Â 
Â  {% if nightmode != 1 or params.NIGHTMODE is defined %} _SET_VELOCITY_LIMIT { rawparams } {% endif %}
Â  {% if params.NIGHTMODE is defined %} SET_GCODE_VARIABLE MACRO=SET_VELOCITY_LIMIT VARIABLE=nightmode VALUE={params.NIGHTMODE|int} {% endif %}


[gcode_macro PRINT_START]
gcode:
Â  Â  ; Cancel any pending delayed fan shutoffs from a previous print
Â  Â  UPDATE_DELAYED_GCODE ID=delayed_fan_shutoff DURATION=0

Â  {% set macro_parkÂ  = params.PARKMACRO |default(printer["gcode_macro _PRINTER_SETTINGS"].macro_park ) %}
Â  {% set macro_purge = params.PURGEMACRO|default(printer["gcode_macro _PRINTER_SETTINGS"].macro_purge) %}

Â  {% set temp_bedÂ  Â  = params.BEDÂ  Â  Â  Â |default(Â  0)|float %}
Â  {% set temp_heÂ  Â  Â = params.HOTENDÂ  Â  |default(205)|float %}
Â  {% set temp_probeÂ  = params.PROBETEMP |default(150)|int %}
Â  {% set do_meshÂ  Â  Â = params.MESHÂ  Â  Â  |default(99)|int %}

Â  {% if printer["gcode_macro _SET_MPC_MATERIAL"] is defined %} _SET_MPC_MATERIAL MATERIAL={params.MATERIAL} {% endif %}

Â  _set_status STATE="status_busy"
Â  _cpufreq_set GOVERNOR=performance
Â  {% if printer["gcode_macro CHECK_ALL_FANS"] is defined %} UPDATE_DELAYED_GCODE ID=CHECK_ALL_FANS DURATION=1 {% endif %}
Â  CLEAR_PAUSE
Â  BED_MESH_CLEAR
Â  SET_GCODE_OFFSET Z=0Â  Â  Â  Â  Â  Â  Â ; clear any Z offset
Â  M107Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ; turn off PCF

Â  Â  ; --- Start Fan Control for PRINT_START ---
Â  Â  {% if printer.fan.mcu is defined %}
Â  Â  Â  Â  SET_FAN_SPEED FAN=mcu SPEED=1.0 ; Turn on electronics cooling fan if defined
Â  Â  {% endif %}

Â  Â  {% if printer.fan.Skirt_Fans is defined %}
Â  Â  Â  Â  SET_FAN_SPEED FAN=Skirt_Fans SPEED=1.0 ; Turn on skirt/auxiliary fan if defined
Â  Â  {% endif %}
Â  Â  ; --- End Fan Control for PRINT_START ---

Â  Â  ; --- Set LED to Orange for Startup Sequence ---
Â  Â  SET_TOOLHEAD_LED_STATUS COLOR="ORANGE"
    G4 P0.2 ; Add a small dwell to make the Orange color visible

Â  M140 S{temp_bed}Â  Â  Â  Â  Â  Â  Â  Â  Â ; set bed temp
Â  M104 S{temp_probe}Â  Â  Â  Â  Â  Â  Â  Â ; set nozzle probe temp

Â  G4 P3000
Â Â 
Â  _set_status STATE="status_homing"
Â  {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %} G28 X Y {% endif %}
Â  G28 Z
Â  {% if temp_bed != 0 %}Â 
Â  Â  _set_status STATE="status_heating"
Â  Â  {% if printer.configfile.settings.scannerÂ  Â is defined %}Â  Â ; preheat scanner coil
Â  Â  Â  {% if printer.heater_bed.temperature < temp_bed * 0.90 %} ; its not a immediate reprintÂ 
Â  Â  Â  Â  {% set th = printer.toolhead %}
Â  Â  Â  Â  G90
Â  Â  Â  Â  G0 Z20
Â  Â  Â  Â  G0 X{th.axis_maximum.x / 2} Y{th.axis_minimum.y + 10} F9000
Â  Â  Â  Â  {% if temp_bed > 80 %} {% set probe_retract = 15 %} {% else %} {% set probe_retract = 5 %} {% endif %}
Â  Â  Â  Â  PROBE_ACCURACY SAMPLES=1 SAMPLE_RETRACT_DIST=5 PROBE_SPEED=5
Â  Â  Â  Â  G0 Z{probe_retract}
Â  Â  Â  {% endif %}
Â  Â  {% endif %}
Â  Â  M190 S{temp_bed}
Â  Â  G0 Z20
Â  {% endif %}

Â  # wipe, no purge {macro_wipe} purge=0
Â Â 
Â  {% if printer.configfile.config.stepper_z1Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  is defined %} _set_status STATE="status_leveling" {% endif %}

Â  {% set tilt_height =Â 
Â  Â  2 if printer.configfile.settings.scanner is definedÂ 
Â  Â  else printer.configfile.settings.z_tilt.horizontal_move_zÂ  Â  Â  Â  Â  Â  if printer.configfile.settings.z_tiltÂ  Â  Â  Â  Â  Â  Â is defined
Â  Â  else printer.configfile.settings.z_tilt_ng.horizontal_move_zÂ  Â  Â  Â  Â if printer.configfile.settings.z_tilt_ngÂ  Â  Â  Â  Â  is defined
Â  Â  else printer.configfile.settings.quad_gantry_level.horizontal_move_z if printer.configfile.settings.quad_gantry_levelÂ  is definedÂ 
Â  Â  else 20 %}
Â  {% if printer.configfile.settings.quad_gantry_level is defined %}
Â  Â  {% if not printer.quad_gantry_level.applied %}Â 
Â  Â  Â  QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=20 RETRY_TOLERANCE=1 PROBE_SPEED=15 LIFT_SPEED=7
Â  Â  {% endif %}
Â  Â  QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z={tilt_height}
Â  {% elif printer.configfile.settings.z_tilt is defined %}
Â  Â  {% if not printer.z_tilt.applied %}
Â  Â  Â  Z_TILT_ADJUST HORIZONTAL_MOVE_Z=20 RETRY_TOLERANCE=1 PROBE_SPEED=15 LIFT_SPEED=7
Â  Â  {% endif %}
Â  Â  Z_TILT_ADJUST HORIZONTAL_MOVE_Z={tilt_height}
Â  {% elif printer.configfile.settings.z_tilt_ng is defined %}
Â  Â  {% if not printer.z_tilt_ng.applied %}
Â  Â  Â  Z_TILT_ADJUST HORIZONTAL_MOVE_Z=20 RETRY_TOLERANCE=1 PROBE_SPEED=15 LIFT_SPEED=7
Â  Â  {% endif %}
Â  Â  Z_TILT_ADJUST HORIZONTAL_MOVE_Z={tilt_height}
Â  {% endif %}

Â  {% if do_mesh == 0 %} RESPOND TYPE=command MSG='Mesh disabled'
Â  {% else %}Â 
Â  Â  _set_status STATE="status_meshing"
Â  Â  {% if do_mesh == 1 %} BED_MESH_CALIBRATE {% else %} BED_MESH_CALIBRATE ADAPTIVE=1 {% endif %}
Â  {% endif %}
Â Â 
Â # Conditionally clean the nozzle on the brush if enabled in printer.cfg
Â  {% if printer['gcode_macro _BRUSH_SETTINGS'] and printer['gcode_macro _BRUSH_SETTINGS'].enabled|lower == 'true' %}
Â  Â  CLEAN_NOZZLE
Â  {% endif %}

Â  {% if printer.configfile.settings.scanner is defined %}
Â  Â  {% if printer.extruder.temperature < temp_probe * 0.95 %}
Â  Â  Â  {% if printer["gcode_macro %s" % (macro_park)]Â  is defined %} {macro_park}Â  {% endif %} ; replace with purge bucket macro
Â  Â  Â  M109 S{temp_probe} ; wait for probe temp
Â  Â  {% endif %}
Â  Â  _set_status STATE="status_calibrating_z"
Â  Â  {% if printer.configfile.settings.bed_mesh.zero_reference_positionÂ  is defined %}
Â  Â  Â  {% set probe_loc_x, probe_loc_y = printer.configfile.config.bed_mesh.zero_reference_position.replace(' ', '').split(',') %}
Â  Â  Â  G90
Â  Â  Â  G0 Z20
Â  Â  Â  #G0 X{probe_loc_x} Y{probe_loc_y} F9000
Â  Â  {% endif %}
Â  Â  CARTOGRAPHER_TOUCH SPEED=2 FUZZY=2
Â  {% else %} G28 Z{% endif %}

Â  _set_status STATE="status_heating"
Â  {% if printer["gcode_macro %s" % (macro_park)]Â  is defined %} {macro_park}Â  {% endif %} ; replace with purge bucket macro
Â  {% if printer["gcode_macro CHECK_ALL_FANS"] is defined %} UPDATE_DELAYED_GCODE ID=CHECK_ALL_FANS DURATION=1 {% endif %}
Â  M109 S{temp_he}

Â  _set_status STATE="status_printing"
Â  {% if macro_purge != 'none' %}Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {macro_purge} {% endif %}Â  Â  Â Â 
Â  #LINE_PURGE

Â  Â  ; --- Set LED to Blue for Actual Printing ---
Â  Â  SET_TOOLHEAD_LED_STATUS COLOR="BLUE"

[gcode_macro _set_status]
gcode:
Â  {% set prt_state = params.STATE|default("none") %}
Â  {% set prt_msgÂ  Â = params.MSGÂ  |default("none") %}
Â  {% if printer.configfile.settings.respondÂ  Â  Â is defined %}
Â  Â  {% if prt_msg == 'none' %}
Â  Â  Â  RESPOND MSG='{"----< %s" % (prt_state|replace("_", " "))}'
Â  Â  {% else %}
Â  Â  Â  RESPOND MSG='{"----< %s" % (prt_msg)}'
Â  Â  {% endif %}
Â  {% endif %}
Â  {% if printer["gcode_macro %s" % (prt_state)] is defined %}
Â  Â  {prt_state}Â 
Â  {% endif %}


[gcode_macro START_PRINT]
gcode:
Â  PRINT_START { rawparams }

[gcode_macro PRINT_END]
gcode:
Â  M400Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ; Finish Moves
Â  CLEAN_NOZZLE
Â  M104 S0Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ; turn off hotend
Â  M140 S0Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ; turn off bed
Â Â 
Â  RESPOND PREFIX=ðŸ’¨ MSG=" Print ended"
Â  _TOOLHEAD_PARK_PAUSE_CANCEL
Â  RESPOND PREFIX=ðŸ’¨ MSG=" Toolhead parked"
Â Â 
Â  M221 S100Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ; reset flow to 100%
Â  M220 S100Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ; reset speed to 100%
Â Â 
Â  SET_FILAMENT_SENSOR SENSOR=hotend_sensor ENABLE=1

Â  RESPOND PREFIX= MSG=""
Â  M117
Â  _set_status STATE="status_ready"

Â  Â  ; Schedule delayed fan shutoff for mcu and Skirt_Fans
Â  Â  UPDATE_DELAYED_GCODE ID=delayed_fan_shutoff DURATION=600 ; 10 minutes (600 seconds)

Â  _cpufreq_set GOVERNOR=ondemand
Â  {% if printer["gcode_macro CHECK_ALL_FANS"] is defined %} UPDATE_DELAYED_GCODE ID=CHECK_ALL_FANS DURATION=0 {% endif %}

Â  M106 S0Â  Â ; turn off part cooling fan immediately
Â Â 

[gcode_macro END_PRINT]
gcode:
Â  PRINT_END { rawparams }

[gcode_macro PARK_REAR]
gcode:
Â  G90
Â  {% set th = printer.toolhead %}
Â  G0 X{th.axis_maximum.x/2} Y{th.axis_maximum.y - 5} F6000

[gcode_macro PARK_FRONT]
gcode:
Â  G90
Â  {% set th = printer.toolhead %}
Â  G0 X{th.axis_maximum.x/2} Y{th.axis_minimum.y + 5} F6000

[gcode_macro RELAX_BELTS]
gcode:
Â  G90
Â  {% set th = printer.toolhead %}
Â  {% set margin = 10 %}
Â  G0 Z50
Â  G0 X{th.axis_maximum.x - margin} Y{th.axis_maximum.y - margin} F6000Â 
Â  G0 X{th.axis_minimum.x + margin} Y{th.axis_minimum.y + margin} F6000Â 
Â  G0 X{th.axis_maximum.x / 2} Y{th.axis_maximum.y / 2} F6000
Â  G0 X{th.axis_minimum.x + margin} F6000
Â  G0 X{th.axis_maximum.x - margin} F6000
Â  G0 X{th.axis_maximum.x / 2} Y{th.axis_maximum.y / 2} F6000
Â  G0 Y{th.axis_minimum.y + margin} F6000
Â  G0 Y{th.axis_maximum.y - margin} F6000
Â  G0 X{th.axis_maximum.x / 2} Y{th.axis_maximum.y / 2} F6000

[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print and set LED to Red.
rename_existing: CANCEL_PRINT_BASE
gcode:
    CLEAR_PAUSE ; Clear any paused state
    M400 ; Finish Moves

    SET_TOOLHEAD_LED_STATUS COLOR="RED" ; Set LED to Red immediately upon cancel

    {% if printer['gcode_macro _BRUSH_SETTINGS'] and printer['gcode_macro _BRUSH_SETTINGS'].enabled|lower == 'true' %}
        CLEAN_NOZZLE
    {% endif %}

    M104 S0 ; Turn off hotend
    M140 S0 ; Turn off bed heater

    _TOOLHEAD_PARK_PAUSE_CANCEL ; Park the toolhead

    M106 S0 ; Turn off part cooling fan immediately

    ; Schedule delayed fan shutoff for mcu and Skirt_Fans
    UPDATE_DELAYED_GCODE ID=delayed_fan_shutoff DURATION=600 ; 10 minutes (600 seconds)

    ; Remaining original CANCEL_PRINT_BASE actions (if any, ensure they are handled by BASE)
    ; RESPOND PREFIX=ðŸ’¨ MSG="Print ended" ; Already in original base
    ; RESPOND PREFIX=ðŸ’¨ MSG="Toolhead parked" ; Already in original base
    ; M221 S100 ; Already in original base
    ; M220 S100 ; Already in original base
    ; SET_FILAMENT_SENSOR SENSOR=hotend_sensor ENABLE=1 ; Already in original base
    ; RESPOND PREFIX= MSG="" ; Already in original base
    ; M117 ; Already in original base
    _set_status STATE="status_ready" ; This is also typically handled by base, but keeping it to ensure it's called
    _cpufreq_set GOVERNOR=ondemand
    {% if printer["gcode_macro CHECK_ALL_FANS"] is defined %} UPDATE_DELAYED_GCODE ID=CHECK_ALL_FANS DURATION=0 {% endif %}

    CANCEL_PRINT_BASE ; Call the original Klipper/Mainsail cancellation logic
    
[gcode_macro SHUTDOWN_PRINTER]
gcode:
Â  {% if "xyz" in printer.toolhead.homed_axes %} _TOOLHEAD_PARK_PAUSE_CANCEL {% endif %}
Â  TURN_OFF_HEATERS
Â  {% if printer['neopixel skirt']Â  Â  Â is defined %}Â  Â 
Â  Â  SET_LED LED="skirt" RED=0 GREEN=0 BLUE=0 SYNC=0 TRANSMIT=1
Â  Â  M400
Â  Â  G4 P2000 {% endif %}
Â  {% if printer['neopixel case_leds'] is defined %}
Â  Â  SET_LED LED="case_leds" RED=0 GREEN=0 BLUE=0 SYNC=0 TRANSMIT=1
Â  Â  M400
Â  Â  G4 P2000 {% endif %}
Â  {% if printer['neopixel sb_leds']Â  Â is defined %}
Â  Â  SET_LED LED="sb_leds" RED=0 GREEN=0 BLUE=0 SYNC=0 TRANSMIT=1
Â  Â  M400
Â  Â  G4 P2000 {% endif %}
Â  M84

# Qoute:
# > this is where the awkwardness of JINJA (the shit in the {}) being a preprocessor shows up
# > the jinja stuff gets executed first, before any of the actual gcode does...
# so 2 macros are needed
#[gcode_macro _PRINTER_POWEROFF]
#gcode:
#Â  {action_call_remote_method("set_device_power", device="printer",STATE=off")}
Â Â 
##################
# Todo: interrutable HEATsoak with delay gcode
[gcode_macro HEATSOAK]Â 
gcode:
Â  _set_status STATE="status_heating"
Â  {% set DWELL = params.DWELL|default(600000)|int %} ; 10 minutesÂ 
Â  G4 P{DWELL}
Â 

## safety firster
[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
description: Perform Mesh Bed Leveling if the printer is leveled, if not level the printer
gcode:
Â  {% if printer.configfile.settings.z_tilt is defined and not printer.z_tilt.applied %}Â 
Â  Â  Z_TILT_ADJUST
Â  Â  G28 Z
Â  {% elif printer.configfile.settings.z_tilt_ng is defined and not printer.z_tilt_ng.applied %}Â 
Â  Â  Z_TILT_ADJUST
Â  Â  G28 Z
Â  {% elif printer.configfile.settings.quad_gantry_level is defined and not printer.quad_gantry_level.applied %}Â 
Â  Â  QUAD_GANTRY_LEVEL
Â  Â  G28 Z
Â  {% endif %}
Â  _BED_MESH_CALIBRATE {rawparams}

# source: https://github.com/Frix-x/klippain/blob/main/macros/helpers/bed_heater_ctrl.cfg
#Â  Â  Â  Â  Â https://github.com/Frix-x/klippain/blob/main/macros/helpers/hotend_heater_ctrl.cfg
# date copy : 2023-11-21
[gcode_macro M109]
rename_existing: M109.1
gcode:
Â  {% set S = params.S|float %}
Â  {% set actual_temp = printer.extruder.temperature|float %}
Â  {% set max_fuzzy = S + 2 %}

Â  M104 { rawparams }Â 
Â  {% if S != 0 %}
Â  Â  {% if actual_temp <= S %} TEMPERATURE_WAIT SENSOR=extruder MINIMUM={S}
Â  Â  {% else %}Â  Â  Â  Â  Â  Â  Â  Â  TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={max_fuzzy} {% endif %}Â  Â 
Â  {% endif %}

[gcode_macro M190]
rename_existing: M190.1
gcode:
Â  {% set S = params.S|float %}
Â  {% set actual_temp = printer.heater_bed.temperature|float %}
Â Â 
Â  {% if printer["gcode_macro _BEDFANVARS"] is defined %}
Â  Â  {% set THRESHOLD = printer["gcode_macro _BEDFANVARS"].threshold|int %}
Â  Â  {% if S >= THRESHOLD %} BEDFANSSLOW
Â  Â  {% else %}Â  Â  Â  Â  Â  Â  Â  BEDFANSOFFÂ  {% endif %}Â 
Â  {% endif %}
Â Â 
Â  M140 { rawparams }Â 
Â  {% if S != 0 %}
Â  Â  {% if actual_temp <= S %} TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={S}
Â  Â  {% else %}Â  Â  Â  Â  Â  Â  Â  Â  TEMPERATURE_WAIT SENSOR=heater_bed MAXIMUM={S} {% endif %}Â  Â 
Â  {% endif %}

Â  {% if printer["gcode_macro _BEDFANVARS"] is defined %} {% if S >= THRESHOLD %} BEDFANSFAST {% endif %}{% endif %}Â 


####
# Convert Marlin linear advance (M900) commands to Klipper (SET_PRESSURE_ADVANCE) commands.
# Used in conjunction with Marlin's linear advance calibration tool:Â 
# https://marlinfw.org/tools/lin_advance/k-factor.html
[gcode_macro M900]
gcode:
Â  {% set pa = params.K|float %}
Â  SET_PRESSURE_ADVANCE ADVANCE={pa}


[gcode_macro M600]
gcode:
Â  PAUSE X=10 Y=10 Z_MIN=50


[gcode_macro LOAD_FILAMENT]
variable_load_distance:Â  50
variable_purge_distance:Â  25
gcode:
Â  {% set speed = params.SPEED|default(300) %}
Â  {% set max_velocity = 50 * 60 %}
Â  SAVE_GCODE_STATE NAME=load_state
Â  G91
Â  G92 E0
Â  G1 E{load_distance} F{max_velocity} # fast-load
Â  G1 E{purge_distance} F{speed} # purge
Â  RESTORE_GCODE_STATE NAME=load_state

[gcode_macro UNLOAD_FILAMENT]
variable_unload_distance:Â  50
variable_purge_distance:Â  25
gcode:
Â  Â  {% set speed = params.SPEED|default(300) %}
Â  Â  {% set max_velocity = 50Â  * 60 %}
Â  Â  SAVE_GCODE_STATE NAME=unload_state
Â  Â  G91
Â  Â  G92 E0
Â  Â  G1 E{purge_distance} F{speed} # purge
Â  Â  G1 E-{unload_distance} F{max_velocity} # fast-unload
Â  Â  RESTORE_GCODE_STATE NAME=unload_state

[gcode_macro SEARCH_VARS]
gcode:
Â  {% set search = params.S|lower %}
Â  {% set ns = namespace() %}
Â  {% for item in printerÂ  %}
Â  Â  {% if ' ' in item %} {% set ns.path = ['printer', "['%s']" % (item), ''] %}
Â  Â  {% else %}Â  Â  Â  Â  Â  Â {% set ns.path = ['printer.', item, '']Â  Â  Â  Â  Â  Â  Â %} {% endif %}Â 
Â  Â  {% if search in ns.path|lower %} { action_respond_info(ns.path|join) }{% endif %}Â 
Â  Â  {% if printer[item].items() %}
Â  Â  Â  {% for childkey, child in printer[item].items() recursive %}
Â  Â  Â  Â  {% set ns.path = ns.path[:loop.depth|int + 1] %}
Â  Â  Â  Â  {% if ' ' in childkey %} {% set null = ns.path.append("['%s']" % (childkey)) %}
Â  Â  Â  Â  {% else %}Â  Â  Â  Â  Â  Â  Â  Â {% set null = ns.path.append(".%s" % (childkey))Â  Â  %}{% endif %}Â 

Â  Â  Â  Â  {% if child is mappingÂ  %} { loop(child.items()) }
Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  {% if search in ns.path|lower %}{ action_respond_info("%s : %s" % (ns.path|join, child)) } {% endif %}Â 
Â  Â  Â  Â  {% endif %}Â  Â  Â  Â  Â  Â 
Â  Â  Â  {% endfor %}
Â  Â  {% endif %}Â 
Â  {% endfor %}

[gcode_macro TAP_DATA]
gcode:
Â  Â  G28
Â  Â  G1 Z5 F1200
Â  Â  M400 ; wait until motor movement finishes
Â  Â  G4 P1000; wait a second so the printer doesn't shake
Â  Â  CARTOGRAPHER_STREAM FILENAME=tapdata2mms.csv
Â  Â  G1 Z-0.5 F120
Â  Â  M400 ; wait until motor movement finishes
Â  Â  G4 P1000; wait a second so the printer doesn't shake
Â  Â  CARTOGRAPHER_STREAM FILENAME=tapdata2mms.csv
Â  Â  G1 Z5 F1200
Â  Â  G28
Â  Â  G1 Z5 F1200
Â  Â  M400 ; wait until motor movement finishes
Â  Â  G4 P1000; wait a second so the printer doesn't shake
Â  Â  CARTOGRAPHER_STREAM FILENAME=tapdata3mms.csv
Â  Â  G1 Z-0.5 F200
Â  Â  M400 ; wait until motor movement finishes
Â  Â  G4 P1000; wait a second so the printer doesn't shake
Â  Â  CARTOGRAPHER_STREAM FILENAME=tapdata3mms.csv
Â  Â  G1 Z10 F800