[gcode_macro PARK]
gcode:
Â  Â  {% set th = printer.toolhead %}
Â  Â  G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30Â 

[gcode_macro G32]
gcode:
Â  Â  BED_MESH_CLEAR
Â  Â  G28
Â  Â  QUAD_GANTRY_LEVEL
Â  Â  G28
Â  Â  G0 X87.5 Y90 Z30 F3600
Â  Â Â 

[gcode_macro PRIME]
gcode:
Â  {% set x_mid = printer.toolhead.axis_maximum.x|float / 2 %}
Â  G0 X{x_mid - 50} Y4 F10000Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  # Go to starting point
Â  G0 Z0.4Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # Raise Z to 0.4
Â  G91Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # Incremental positioningÂ 
Â  G1 X100 E20 F1000Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â # Primeline
Â  G90

[gcode_macro testy]
gcode:
Â  #G4 P{printer["gcode_macro _PRINTER_SETTINGS"].prepurge_dwell * 1000}
Â  #RESPOND TYPE=echo MSG="dwelling"
Â  #RESPOND TYPE=echo MSG='{"Move isÂ  %d" % (tilt_height)}'Â  Â  Â  Â  Â  Â Â 
Â  #RESPOND PREFIX=ðŸ’¨ MSG=" {planeCfg} {planeCMD} "

[gcode_macro _set_status]
gcode:
Â  {% set prt_state = params.STATE|default("none") %}
Â  {% set prt_msgÂ  Â = params.MSGÂ  |default("none") %}
Â  {% if printer.configfile.settings.respond is defined %}
Â  Â  {% if prt_msg == 'none' %}
Â  Â  Â  RESPOND MSG='{"----< %s" % (prt_state|replace("_", " "))}'
Â  Â  {% else %}
Â  Â  Â  RESPOND MSG='{"----< %s" % (prt_msg)}'
Â  Â  {% endif %}
Â  {% endif %}
Â  {% if printer["gcode_macro %s" % (prt_state)] is defined %}
Â  Â  {prt_state}Â 
Â  {% endif %}

[delayed_gcode delayed_fan_shutoff]
initial_duration: 0.0 ; Don't run immediately on Klipper start
gcode:
    M118 "Delayed fan shutoff active (10 minutes reached)."
    {% if printer['fan_generic mcu'] is defined %}
        SET_FAN_SPEED FAN=mcu SPEED=0 ; Turn off electronics cooling fan if defined
    {% endif %}

    {% if printer['fan_generic Skirt_Fans'] is defined %}
        SET_FAN_SPEED FAN=Skirt_Fans SPEED=0 ; Turn off skirt/auxiliary fan if defined
    {% endif %}
Â Â 
[delayed_gcode chill_absprint]
gcode:
Â  {% if printer.heater_bed.temperature > 80 %}
Â  Â  SET_DISPLAY_TEXT MSG="reduce temp to ({printer.heater_bed.target - 5 }CÂ°)." M140 S{ printer.heater_bed.target - 5 }
Â  Â  UPDATE_DELAYED_GCODE ID=chill_absprint DURATION=300
Â  {% else %}
Â  Â  SET_DISPLAY_TEXT MSG="No Gradual bed cooling necessary ({printer.heater_bed.temperature}CÂ°)." M140 S0 ; turn off bed
Â  Â  #M81 ; disable Power
Â  Â  SET_DISPLAY_TEXT MSG="Print Complete!" {% endif %}

Â  M106 S85
Â  TEMPERATURE_WAIT SENSOR=extruder MAXIMUM=150
Â  SET_FAN_SPEED FAN=mcu SPEED=1.0Â 
Â Â 
Â  {% set posCenter = printer.configfile.config.bed_mesh.zero_reference_position %}
Â  {% set moveAccelÂ  = printer.configfile.config.printer.max_accel | int * 0.80 %}
Â  G91
Â  G0 Z20
Â  G90
Â  G1 X{posCenter.split(",")[0]|float} Y{posCenter.split(",")[1]|float} F{moveAccel}
Â Â 
Â  M84

Â  G4 P300000
Â  M140 S105
Â  G4 P300000
Â  M140 S100
Â  G4 P300000
Â  M140 S95
Â  G4 P300000
Â  M140 S90
Â  G4 P300000

Â  M106 S0
Â  M140 S0
Â  SET_FAN_SPEED FAN=mcu SPEED=0

[gcode_macro SET_VELOCITY_LIMIT]
rename_existing: _SET_VELOCITY_LIMIT
description: Alter the velocity limits unless printer is in nightmode
variable_nightmode: 0Â 
gcode:Â 
Â  {% if nightmode != 1 or params.NIGHTMODE is defined %} _SET_VELOCITY_LIMIT { rawparams } {% endif %}
Â  {% if params.NIGHTMODE is defined %} SET_GCODE_VARIABLE MACRO=SET_VELOCITY_LIMIT VARIABLE=nightmode VALUE={params.NIGHTMODE|int} {% endif %}


[gcode_macro PRINT_START]
gcode:
    ; Cancel any pending delayed fan shutoffs from a previous print
    UPDATE_DELAYED_GCODE ID=delayed_fan_shutoff DURATION=0

    {% set macro_park  = params.PARKMACRO |default(printer["gcode_macro _PRINTER_SETTINGS"].macro_park ) %}
    {% set macro_purge = params.PURGEMACRO|default(printer["gcode_macro _PRINTER_SETTINGS"].macro_purge) %}

    {% set temp_bed    = params.BED       |default(  0)|float %}
    {% set temp_he     = params.HOTEND    |default(205)|float %}
    {% set temp_probe  = params.PROBETEMP |default(150)|int %}
    {% set do_mesh     = params.MESH      |default(99)|int %}

    {% if printer["gcode_macro _SET_MPC_MATERIAL"] is defined %}
        _SET_MPC_MATERIAL MATERIAL={params.MATERIAL}
    {% endif %}

    _set_status STATE="status_busy"
    CLEAR_PAUSE
    BED_MESH_CLEAR
    SET_GCODE_OFFSET Z=0
    M107

    ; --- Start: Formatted Fan Control ---
    {% if printer['fan_generic mcu'] is defined %}
        SET_FAN_SPEED FAN=mcu SPEED=1.0
        RESPOND MSG='{"----< fan mcu on"}'
    {% else %}
        RESPOND MSG='{"----< fan mcu not defined"}'
    {% endif %}

    {% if printer['fan_generic Skirt_Fans'] is defined %}
        SET_FAN_SPEED FAN=Skirt_Fans SPEED=1.0
        RESPOND MSG='{"----< fan skirt on"}'
    {% else %}
        RESPOND MSG='{"----< fan skirt not defined"}'
    {% endif %}
    ; --- End: Formatted Fan Control ---

    ; Turn on Chamber Light if defined
    {% if printer['neopixel Chamber_Light'] is defined %}
        SET_LED LED=Chamber_Light RED=1.0 GREEN=1.0 BLUE=1.0
    {% endif %}

    M140 S{temp_bed}
    M104 S{temp_probe}

    G4 P3000
    
    _set_status STATE="status_homing"
    {% if 'x' not in printer.toolhead.homed_axes or 'y' not in printer.toolhead.homed_axes %}
        G28 X Y
    {% endif %}
    G28 Z
    {% if temp_bed != 0 %} 
        _set_status STATE="status_heating"
        {% if printer.configfile.settings.scanner is defined %}
            {% if printer.heater_bed.temperature < temp_bed * 0.90 %}
                {% set th = printer.toolhead %}
                G90
                G0 Z20
                G0 X{th.axis_maximum.x / 2} Y{th.axis_minimum.y + 10} F9000
                {% if temp_bed > 80 %}
                    {% set probe_retract = 15 %}
                {% else %}
                    {% set probe_retract = 5 %}
                {% endif %}
                PROBE_ACCURACY SAMPLES=1 SAMPLE_RETRACT_DIST=5 PROBE_SPEED=5
                G0 Z{probe_retract}
            {% endif %}
        {% endif %}
        M190 S{temp_bed}
        G0 Z20
    {% endif %}
    
    ; --- Start: Robust tilt_height calculation ---
    {% set tilt_height = 20 %} ; Default value
    {% if printer.configfile.settings.scanner is defined %}
        {% set tilt_height = 2 %}
    {% elif printer.configfile.settings.z_tilt is defined %}
        {% set tilt_height = printer.configfile.settings.z_tilt.horizontal_move_z %}
    {% elif printer.configfile.settings.z_tilt_ng is defined %}
        {% set tilt_height = printer.configfile.settings.z_tilt_ng.horizontal_move_z %}
    {% elif printer.configfile.settings.quad_gantry_level is defined %}
        {% set tilt_height = printer.configfile.settings.quad_gantry_level.horizontal_move_z %}
    {% endif %}
    ; --- End: Robust tilt_height calculation ---

    {% if printer.configfile.settings.quad_gantry_level is defined %}
        {% if not printer.quad_gantry_level.applied %} 
            QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z=20 RETRY_TOLERANCE=1 PROBE_SPEED=15 LIFT_SPEED=7
        {% endif %}
        QUAD_GANTRY_LEVEL HORIZONTAL_MOVE_Z={tilt_height}
    {% elif printer.configfile.settings.z_tilt is defined %}
        {% if not printer.z_tilt.applied %}
            Z_TILT_ADJUST HORIZONTAL_MOVE_Z=20 RETRY_TOLERANCE=1 PROBE_SPEED=15 LIFT_SPEED=7
        {% endif %}
        Z_TILT_ADJUST HORIZONTAL_MOVE_Z={tilt_height}
    {% elif printer.configfile.settings.z_tilt_ng is defined %}
        {% if not printer.z_tilt_ng.applied %}
            Z_TILT_ADJUST HORIZONTAL_MOVE_Z=20 RETRY_TOLERANCE=1 PROBE_SPEED=15 LIFT_SPEED=7
        {% endif %}
        Z_TILT_ADJUST HORIZONTAL_MOVE_Z={tilt_height}
    {% endif %}


    {% if do_mesh == 0 %}
        RESPOND TYPE=command MSG='Mesh disabled'
    {% else %} 
        _set_status STATE="status_meshing"
        {% if do_mesh == 1 %}
            BED_MESH_CALIBRATE
        {% else %}
            BED_MESH_CALIBRATE ADAPTIVE=1
        {% endif %}
    {% endif %}
    
    ; Conditionally clean the nozzle on the brush if enabled in printer.cfg
    {% if printer['gcode_macro _BRUSH_SETTINGS'] and printer['gcode_macro _BRUSH_SETTINGS'].enabled|lower == 'true' %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel}
        _set_status STATE="status_cleaning"
        CLEAN_NOZZLE
    {% endif %}

    {% if printer.configfile.settings.scanner is defined %}
        {% if printer.extruder.temperature < temp_probe * 0.95 %}
            {% if printer["gcode_macro %s" % (macro_park)] is defined %}
                {macro_park}
            {% endif %}
            SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp_probe}
            TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp_probe}
        {% endif %}
        _set_status STATE="status_calibrating_z"
        {% if printer.configfile.settings.bed_mesh.zero_reference_position is defined %}
            {% set probe_loc_x, probe_loc_y = printer.configfile.config.bed_mesh.zero_reference_position.replace(' ', '').split(',') %}
            G90
            G0 Z20
        {% endif %}
        CARTOGRAPHER_TOUCH SPEED=2 FUZZY=2
    {% else %}
        G28 Z
    {% endif %}

    _set_status STATE="status_heating"
    {% if printer["gcode_macro %s" % (macro_park)] is defined %}
        {macro_park}
    {% endif %}
    {% if printer["gcode_macro CHECK_ALL_FANS"] is defined %}
        UPDATE_DELAYED_GCODE ID=CHECK_ALL_FANS DURATION=1
    {% endif %}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={temp_he}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={temp_he}

    _set_status STATE="status_printing"
    {% if macro_purge != 'none' %}
        {macro_purge}
    {% endif %}

[gcode_macro PRINT_END]
gcode:
    M400 ; Finish Moves

    ; --- Start of anti-ooze retraction ---
    {% set retract_dist = printer["gcode_macro _CLIENT_VARIABLE"].cancel_retract|default(5.0)|float %}
    {% set retract_spd = printer["gcode_macro _CLIENT_VARIABLE"].speed_retract|default(30.0)|float %}
    G91 ; Relative positioning
    G1 E-{retract_dist} F{retract_spd * 60} ; Retract filament
    G90 ; Absolute positioning
    ; --- End of anti-ooze retraction ---

    _set_status STATE="status_cleaning" ; Added status macro
    CLEAN_NOZZLE
    M104 S0 ; turn off hotend
    M140 S0 ; turn off bed
    
    RESPOND PREFIX=ðŸ’¨ MSG=" Print ended"
    _TOOLHEAD_PARK_PAUSE_CANCEL
    RESPOND PREFIX=ðŸ’¨ MSG=" Toolhead parked"
    
    M221 S100 ; reset flow to 100%
    M220 S100 ; reset speed to 100%
    
    SET_FILAMENT_SENSOR SENSOR=hotend_sensor ENABLE=1

    RESPOND PREFIX= MSG=""
    M117
    _set_status STATE="status_ready"
    
    ; Schedule delayed fan shutoff for mcu and Skirt_Fans
    UPDATE_DELAYED_GCODE ID=delayed_fan_shutoff DURATION=600 ; 10 minutes (600 seconds)

    {% if printer["gcode_macro CHECK_ALL_FANS"] is defined %} UPDATE_DELAYED_GCODE ID=CHECK_ALL_FANS DURATION=0 {% endif %}

    M106 S0 ; turn off part cooling fan immediately

    ; Turn on Chamber Light to Green at 100% if defined
    {% if printer['neopixel Chamber_Light'] is defined %}
        SET_LED LED=Chamber_Light RED=0.0 GREEN=1.0 BLUE=0.0
    {% endif %}

[gcode_macro END_PRINT]
gcode:
Â  PRINT_END { rawparams }

[gcode_macro PARK_REAR]
gcode:
Â  G90
Â  {% set th = printer.toolhead %}
Â  G0 X{th.axis_maximum.x/2} Y{th.axis_maximum.y - 5} F6000

[gcode_macro PARK_FRONT]
gcode:
Â  G90
Â  {% set th = printer.toolhead %}
Â  G0 X{th.axis_maximum.x/2} Y{th.axis_minimum.y + 5} F6000

[gcode_macro RELAX_BELTS]
gcode:
Â  G90
Â  {% set th = printer.toolhead %}
Â  {% set margin = 10 %}
Â  G0 Z50
Â  G0 X{th.axis_maximum.x - margin} Y{th.axis_maximum.y - margin} F6000Â 
Â  G0 X{th.axis_minimum.x + margin} Y{th.axis_minimum.y + margin} F6000Â 
Â  G0 X{th.axis_maximum.x / 2} Y{th.axis_maximum.y / 2} F6000
Â  G0 X{th.axis_minimum.x + margin} F6000
Â  G0 X{th.axis_maximum.x - margin} F6000
Â  G0 X{th.axis_maximum.x / 2} Y{th.axis_maximum.y / 2} F6000
Â  G0 Y{th.axis_minimum.y + margin} F6000
Â  G0 Y{th.axis_maximum.y - margin} F6000
Â  G0 X{th.axis_maximum.x / 2} Y{th.axis_maximum.y / 2} F6000

[gcode_macro CANCEL_PRINT]
description: "Cancel the actual running print and set LED to Red."
rename_existing: CANCEL_PRINT_BASE
gcode:
    CLEAR_PAUSE
    M400 ; Finish Moves

    ; --- Start of anti-ooze retraction ---
    {% set retract_dist = printer["gcode_macro _CLIENT_VARIABLE"].cancel_retract|default(5.0)|float %}
    {% set retract_spd = printer["gcode_macro _CLIENT_VARIABLE"].speed_retract|default(30.0)|float %}
    G91 ; Relative positioning
    G1 E-{retract_dist} F{retract_spd * 60} ; Retract filament
    G90 ; Absolute positioning
    ; --- End of anti-ooze retraction ---

    {% if printer['gcode_macro _BRUSH_SETTINGS'] and printer['gcode_macro _BRUSH_SETTINGS'].enabled|lower == 'true' %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel}
        _set_status STATE="status_cleaning"
        CLEAN_NOZZLE
    {% endif %}

    M104 S0
    M140 S0

    _TOOLHEAD_PARK_PAUSE_CANCEL

    M106 S0

    UPDATE_DELAYED_GCODE ID=delayed_fan_shutoff DURATION=600

    {% if printer['neopixel Chamber_Light'] is defined %}
        SET_LED LED=Chamber_Light RED=1.0 GREEN=0.0 BLUE=0.0
    {% endif %}

    _set_status STATE="status_ready"
    {% if printer["gcode_macro CHECK_ALL_FANS"] is defined %}
        UPDATE_DELAYED_GCODE ID=CHECK_ALL_FANS DURATION=0
    {% endif %}

    CANCEL_PRINT_BASE
Â  Â Â 
[gcode_macro SHUTDOWN_PRINTER]
gcode:
Â  {% if "xyz" in printer.toolhead.homed_axes %} _TOOLHEAD_PARK_PAUSE_CANCEL {% endif %}
Â  TURN_OFF_HEATERS
Â  {% if printer['neopixel skirt']Â  Â  Â  is defined %}Â Â 
Â  Â  SET_LED LED="skirt" RED=0 GREEN=0 BLUE=0 SYNC=0 TRANSMIT=1
Â  Â  M400
Â  Â  G4 P2000 {% endif %}
Â  {% if printer['neopixel case_leds'] is defined %}
Â  Â  SET_LED LED="case_leds" RED=0 GREEN=0 BLUE=0 SYNC=0 TRANSMIT=1
Â  Â  M400
Â  Â  G4 P2000 {% endif %}
Â  {% if printer['neopixel sb_leds']Â  Â  is defined %}
Â  Â  SET_LED LED="sb_leds" RED=0 GREEN=0 BLUE=0 SYNC=0 TRANSMIT=1
Â  Â  M400
Â  Â  G4 P2000 {% endif %}
Â  M84
Â  _set_status STATE="status_off" ; Added status macro

# Qoute:
# > this is where the awkwardness of JINJA (the shit in the {}) being a preprocessor shows up
# > the jinja stuff gets executed first, before any of the actual gcode does...
# so 2 macros are needed
#[gcode_macro _PRINTER_POWEROFF]
#gcode:
#Â  {action_call_remote_method("set_device_power", device="printer",STATE=off")}
Â Â 
##################
# Todo: interrutable HEATsoak with delay gcode
[gcode_macro HEATSOAK]Â 
gcode:
Â  _set_status STATE="status_heating"
Â  {% set DWELL = params.DWELL|default(600000)|int %} ; 10 minutesÂ 
Â  G4 P{DWELL}
Â Â 

## safety firster
[gcode_macro BED_MESH_CALIBRATE]
rename_existing: _BED_MESH_CALIBRATE
description: Perform Mesh Bed Leveling if the printer is leveled, if not level the printer
gcode:
Â  {% if printer.configfile.settings.z_tilt is defined and not printer.z_tilt.applied %}Â 
Â  Â  _set_status STATE="status_leveling" ; Added status macro
Â  Â  Z_TILT_ADJUST
Â  Â  G28 Z
Â  {% elif printer.configfile.settings.z_tilt_ng is defined and not printer.z_tilt_ng.applied %}Â 
Â  Â  _set_status STATE="status_leveling" ; Added status macro
Â  Â  Z_TILT_ADJUST
Â  Â  G28 Z
Â  {% elif printer.configfile.settings.quad_gantry_level is defined and not printer.quad_gantry_level.applied %}Â 
Â  Â  _set_status STATE="status_leveling" ; Added status macro
Â  Â  QUAD_GANTRY_LEVEL
Â  Â  G28 Z
Â  {% endif %}
Â  _BED_MESH_CALIBRATE {rawparams}
Â  _set_status STATE="status_ready" ; Added status macro


####
# Convert Marlin linear advance (M900) commands to Klipper (SET_PRESSURE_ADVANCE) commands. # Used in conjunction with Marlin's linear advance calibration tool:Â 
# https://marlinfw.org/tools/lin_advance/k-factor.html
[gcode_macro M900]
gcode:
Â  {% set pa = params.K|float %}
Â  SET_PRESSURE_ADVANCE ADVANCE={pa}


[gcode_macro M600]
gcode:
Â  PAUSE X=10 Y=10 Z_MIN=50
Â  _set_status STATE="status_busy" ; Added status macro (already there)

# Override Klipper's built-in PAUSE command
[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
gcode:
Â  Â  # Execute the original PAUSE command functionality
Â  Â  PAUSE_BASE {rawparams}

Â  Â  ; Conditional statement: if Chamber_Light is defined, turn it yellow (100%)
Â  Â  {% if printer['neopixel Chamber_Light'] is defined %}
Â  Â  Â  Â  SET_LED LED=Chamber_Light RED=1.0 GREEN=1.0 BLUE=0.0 ; Yellow (R=1.0, G=1.0, B=0.0)
Â  Â  {% endif %}

Â  Â  ; You might also want to set a specific toolhead LED status for paused state
Â  Â  ; For example, if you had a 'status_paused' in toolhead_led.txt, you would call:
Â  Â  ; _set_status STATE="status_paused"
Â  Â  ; For now, we rely on the direct light change

[gcode_macro LOAD_FILAMENT]
description: "Load filament into the extruder, with optional purge bucket and clean"
gcode:
    {% set settings = printer["gcode_macro _CLIENT_VARIABLE"] %}
    {% set load_temp = settings.load_temp|float %}
    {% set load_speed = settings.load_feed_speed|float %}
    {% set load_fast_speed = settings.load_fast_speed|float %}
    {% set load_length = settings.load_length|float %}
    {% set purge_length = settings.purge_length|float %}
    
    {% set use_bucket = settings.use_purge_bucket|default(false)|lower == 'true' %}
    {% if use_bucket %}
        {% set purge_x = settings.purge_bucket_x|default(0)|float %}
        {% set purge_y = settings.purge_bucket_y|default(0)|float %}
        {% set purge_z = settings.purge_bucket_z|default(10)|float %}
    {% endif %}

    SAVE_GCODE_STATE NAME=LOAD_FILAMENT_STATE

    ; --- Move to purge bucket first (if enabled) ---
    {% if use_bucket %}
        {% if "xyz" not in printer.toolhead.homed_axes %}
            RESPOND MSG='{"----< homing required..."}'
            G28
        {% endif %}
        RESPOND MSG='{"----< moving to purge bucket..."}'
        G90
        G0 Z{purge_z + 20} F1800
        G0 X{purge_x} Y{purge_y} F6000
        G0 Z{purge_z} F1800
    {% endif %}
    
    RESPOND MSG='{"----< heating nozzle to %s C" % load_temp}'
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={load_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={load_temp}
    
    RESPOND MSG='{"----< disabling Filament Sensors"}'
    SET_FILAMENT_SENSOR SENSOR=hotend_sensor ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=extruder_sensor ENABLE=0

    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={printer.configfile.settings.extruder.min_extrude_temp|default(170)|float}
    
    RESPOND MSG='{"----< please insert filament now, then press RESUME"}'
    PAUSE
    
    RESPOND MSG='{"----< loading filament..."}'
    M83 ; Relative extrusion mode
    G1 E{load_length - purge_length} F{load_fast_speed * 60}
    G1 E{purge_length} F{load_speed * 60}
    
    ; --- Clean nozzle ---
    RESPOND MSG='{"----< cleaning nozzle..."}'
    SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel}
    CLEAN_NOZZLE
    
    ; --- Park toolhead ---
    RESPOND MSG='{"----< parking toolhead..."}'
    _TOOLHEAD_PARK_PAUSE_CANCEL
    
    RESPOND MSG='{"----<filament Load Complete"}'
    RESPOND MSG='{"----< enabling Filament Sensors"}'
    SET_FILAMENT_SENSOR SENSOR=hotend_sensor ENABLE=1
    SET_FILAMENT_SENSOR SENSOR=extruder_sensor ENABLE=1
    
    RESTORE_GCODE_STATE NAME=LOAD_FILAMENT_STATE


[gcode_macro UNLOAD_FILAMENT]
description: "Unload filament from the extruder with advanced tip forming"
gcode:
    {% set settings = printer["gcode_macro _CLIENT_VARIABLE"] %}
    {% set unload_temp = settings.unload_temp|float %}
    {% set unload_fast_speed = settings.unload_fast_speed|float %}
    {% set unload_length = settings.unload_length|float %}
    {% set tip_cycles = settings.tip_forming_cycles|default(5)|int %}
    {% set tip_move_length = settings.tip_forming_move_length|default(2.0)|float %}
    {% set tip_move_speed = settings.tip_forming_move_speed|default(25.0)|float %}

    SAVE_GCODE_STATE NAME=UNLOAD_FILAMENT_STATE
    
    RESPOND MSG='{"----< Heating nozzle to %s C" % unload_temp}'
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={unload_temp}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={unload_temp}
    
    RESPOND MSG='{"----< Disabling Filament Sensors"}'
    SET_FILAMENT_SENSOR SENSOR=hotend_sensor ENABLE=0
    SET_FILAMENT_SENSOR SENSOR=extruder_sensor ENABLE=0

    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={printer.configfile.settings.extruder.min_extrude_temp|default(170)|float}
    
    RESPOND MSG='{"----< Forming filament tip..."}'
    M83 ; Relative extrusion mode
    
    ; --- Start of Tip Forming Loop ---
    {% for i in range(tip_cycles) %}
        G1 E{tip_move_length} F{tip_move_speed * 60}
        G1 E-{tip_move_length} F{tip_move_speed * 60}
    {% endfor %}
    ; --- End of Tip Forming Loop ---
    
    RESPOND MSG='{"----< Unloading filament..."}'
    G1 E-{unload_length} F{unload_fast_speed * 60} ; Fast retract

    RESPOND MSG='{"----< Filament Unload Complete"}'
    RESPOND MSG='{"----< Enabling Filament Sensors"}'
    SET_FILAMENT_SENSOR SENSOR=hotend_sensor ENABLE=1
    SET_FILAMENT_SENSOR SENSOR=extruder_sensor ENABLE=1

    RESTORE_GCODE_STATE NAME=UNLOAD_FILAMENT_STATE

[gcode_macro SEARCH_VARS]
gcode:
Â  {% set search = params.S|lower %}
Â  {% set ns = namespace() %}
Â  {% for item in printerÂ  %}
Â  Â  {% if ' ' in item %} {% set ns.path = ['printer', "['%s']" % (item), ''] %}
Â  Â  {% else %}Â  Â  Â  Â  Â  {% set ns.path = ['printer.', item, '']Â  Â  Â  Â  Â  Â  %} {% endif %}Â 
Â  Â  {% if search in ns.path|lower %} { action_respond_info(ns.path|join) }{% endif %}Â 
Â  Â  {% if printer[item].items() %}
Â  Â  Â  {% for childkey, child in printer[item].items() recursive %}
Â  Â  Â  Â  {% set ns.path = ns.path[:loop.depth|int + 1] %}
Â  Â  Â  Â  {% if ' ' in childkey %} {% set null = ns.path.append("['%s']" % (childkey)) %}
Â  Â  Â  Â  {% else %}Â  Â  Â  Â  Â  Â  Â  Â  {% set null = ns.path.append(".%s" % (childkey))Â  Â  %}{% endif %}Â 

Â  Â  Â  Â  {% if child is mappingÂ  %} { loop(child.items()) }
Â  Â  Â  Â  {% else %}
Â  Â  Â  Â  Â  Â  {% if search in ns.path|lower %}{ action_respond_info("%s : %s" % (ns.path|join, child)) } {% endif %}Â 
Â  Â  Â  Â  {% endif %}Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  {% endfor %}
Â  Â  {% endif %}Â 
Â  {% endfor %}

[gcode_macro TAP_DATA]
gcode:
Â  Â  G28
Â  Â  G1 Z5 F1200
Â  Â  M400 ; wait until motor movement finishes
Â  Â  G4 P1000; wait a second so the printer doesn't shake
Â  Â  CARTOGRAPHER_STREAM FILENAME=tapdata2mms.csv
Â  Â  G1 Z-0.5 F120
Â  Â  M400 ; wait until motor movement finishes
Â  Â  G4 P1000; wait a second so the printer doesn't shake
Â  Â  CARTOGRAPHER_STREAM FILENAME=tapdata2mms.csv
Â  Â  G1 Z5 F1200
Â  Â  G28
Â  Â  G1 Z5 F1200
Â  Â  M400 ; wait until motor movement finishes
Â  Â  G4 P1000; wait a second so the printer doesn't shake
Â  Â  CARTOGRAPHER_STREAM FILENAME=tapdata3mms.csv
Â  Â  G1 Z-0.5 F200
Â  Â  M400 ; wait until motor movement finishes
Â  Â  G4 P1000; wait a second so the printer doesn't shake
Â  Â  CARTOGRAPHER_STREAM FILENAME=tapdata3mms.csv
Â  Â  G1 Z10 F800